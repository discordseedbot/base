<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>startup.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="StorageConnection.html">StorageConnection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageConnection.html#raw">raw</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageConnection.html#resetConnection">resetConnection</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-CoreBuildTools.html">CoreBuildTools</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-CoreBuildTools.html#.increment">increment</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-CoreLibrary.html">CoreLibrary</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-CoreLibrary.html#.getModules">getModules</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-CoreLibrary.html#.getNPMArray">getNPMArray</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-CoreLibrary.html#.getParameters">getParameters</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-CoreLibrary.html#.getPrefrences">getPrefrences</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-CoreLibrary.html#.setParameter">setParameter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-CoreLibrary.html#.startup">startup</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-CoreModule.html">CoreModule</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-CoreToken.html">CoreToken</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-DistributionConfig.html">DistributionConfig</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Manifest.html">Manifest</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Prefrences.html">Prefrences</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-StorageManager.html">StorageManager</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#SB">SB</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">startup.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const toolbox = require("tinytoolbox");
/**
 * @extends module:CoreLibrary
 * @description Function that holds all of the tasks necessary to start up. The majority of these are async functions that require await
 * @async
 */
module.exports = async()=>{

	await SB.core.getParameters()
	global.SB.token = await SB.core.token.getTokens();

	// Set all of the variables in `global.SB`
	global.SB.parameters = await SB.core.getParameters();

	// Populate Modules Object
	global.SB.modules = await SB.core.getModules();

	// Increment Build Number for Somewhat Easier Version Control.
	if (SB.parameters.developer) {
		SB.core.build.increment()
	}

	if (SB.token.discord.length &lt; 56) {
		console.error(`[startup] Discord Token is to small`);
		process.exit(1);
	}

	global.SB.client = new SB.modules.node["discord.js"].Client();

	toolbox.async.forEach(SB.modules.bot,(module)=>{
		var dbConnection = null;
		var dbFileName = `${module.manifest.name}-${module.manifest.type}-${require("crypto").createHash('md5').update(JSON.stringify(module.manifest)).digest('hex')}.db3`
		if (SB.core.storageManager.databaseExists(dbFileName)) {
			dbConnection = new SB.core.storageManager.connection({url:`sqlite:///data/db/${dbFileName}`});
		}
		
		var moduleData = {
			script: module.script,
			manifest: module.manifest,
			type: module.manifest.type,
			loadedTimestamp: Date.now(),
			storage: dbConnection
		}
		SB.client.on('ready',()=>{
			if (module.script.onMessage != undefined &amp;&amp; typeof module.script.onMessage == "function") {
				module.script.onMessage(SB.Client,moduleStorage)
			}
		})

		global.SB.modules.loaded.push(moduleData);
	})

	SB.modules.loaded.forEach((module)=>{

		if (module.type !== "bot" || module.type !== "generic") return;
		if (module.script.onReady !== undefined &amp;&amp; typeof module.script.onReady == "function") {
			SB.client.on('ready',()=>{
				module.script.onReady(module)
			})
		}

		if (module.script.onMessage !== undefined &amp;&amp; typeof module.script.onMessage == "function" &amp;&amp; module.type == "bot") {
			SB.client.on('message',(Message)=>{
				if (Message.author.bot) return;
				Message.arguments = Message.content.split(' ').shift() || [];
				var prefix = SB.prefrences.prefix.default;
				Message.command = Message.content.replace(prefix,"");
				if (Message.command.split(' ').length[1] !== undefined) { Message.command = Message.command.split(' ')[0]; }
				toolbox.async.forEach(toolbox.JSON.toArray(SB.prefrences.prefix.default),(pfx)=>{
					if (Message.content.startsWith(pfx[1])) {
						prefix = pfx[1];
					}
				})

				module.script.onMessage(Message,module)
			})
		}
	})
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Thu Mar 25 2021 12:00:52 GMT+0800 (Australian Western Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
